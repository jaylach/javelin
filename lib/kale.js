"use strict";

var fs = require('fs');
var path = require('path');
var Compiler = require('./compiler');
var Engine = require('./engine');
var parser = require('./parser').parser;
parser.yy = require('./nodes');

var _ = require('lodash');

// Create our engine
var $engine = new Engine();
var _kaleActions = require('./actions');

_.forEach(_.pairs(_kaleActions), function(pair) {
  var name = pair[0];
  var action = pair[1];

  $engine.addAction(name, action);
});

// Kale Functions

// compile()
var compile = function compile(string) {
  var ast = parser.parse(string);

  var c = new Compiler(ast);
  var result = c.compile();

  _.forEach(_.pairs(result), function(pairs) {
    $engine._addTemplate(pairs[0], pairs[1]);
  });

  return $engine;
}; //- compile()

// compileFile()
var compileFile = function compileFile(fileName) {
  var contents = fs.readFileSync(fileName, 'utf8');  

  return compile(contents)
}; //- compileFile()

// render()
var render = function render(string, input, locals) {
  var compiled = compile(string);

  return compiled(input, locals);
}; //- render()

// renderFile()
var renderFile = function renderFile(fileName, input, locals) {
  var compiled = compileFile(fileName);

  return compiled(input, locals);
}; //- renderFile()

// addAction()
var addAction = function addAction(actionName, actionFunc) {
  $engine.addAction(actionName, actionFunc);
}; //- addAction()

var input2 = {"dataSourceRow":{"id":11,"tenantId":3,"dtSrcType":"Truck","createdTs":{"time":1418916843405},"modifiedTs":{"time":1418916843405},"currentInstanceId":0},"domainDicsForDataSrc":[{"ddEntry":{"id":267,"name":"Capacity","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":267,"dataSourceId":11,"isKey":false,"id":101,"optionsJson":{},"label":"Capacity","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":286,"name":"Empty Weight","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":286,"dataSourceId":11,"isKey":false,"id":102,"optionsJson":{},"label":"Empty Weight","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":290,"name":"Full Description","description":"","widgetId":14,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":14,"name":"textbox","widgetCategoryTypeId":3,"editWidget":"textbox","filterWidget":"select-autocomp"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":290,"dataSourceId":11,"isKey":false,"id":99,"optionsJson":{},"label":"Full Description","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":291,"name":"Gross Vehicle Weight","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":291,"dataSourceId":11,"isKey":false,"id":103,"optionsJson":{},"label":"Gross Vehicle Weight","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":292,"name":"Height","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":292,"dataSourceId":11,"isKey":false,"id":104,"optionsJson":{},"label":"Height","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":298,"name":"Inspection Due","description":"","widgetId":12,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":12,"name":"date","widgetCategoryTypeId":2,"editWidget":"date","filterWidget":"date"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":298,"dataSourceId":11,"isKey":false,"id":105,"optionsJson":{},"label":"Inspection Due","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":300,"name":"Inspection Interval","description":"","widgetId":1,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":1,"name":"select","widgetCategoryTypeId":1,"editWidget":"select-autocomplete","filterWidget":"select-autocomplete"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":300,"dataSourceId":11,"isKey":false,"id":106,"optionsJson":{},"label":"Inspection Interval","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":302,"name":"Insurance Due","description":"","widgetId":12,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":12,"name":"date","widgetCategoryTypeId":2,"editWidget":"date","filterWidget":"date"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":302,"dataSourceId":11,"isKey":false,"id":107,"optionsJson":{},"label":"Insurance Due","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":303,"name":"Insurance Interval","description":"","widgetId":1,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":1,"name":"select","widgetCategoryTypeId":1,"editWidget":"select-autocomplete","filterWidget":"select-autocomplete"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":303,"dataSourceId":11,"isKey":false,"id":108,"optionsJson":{},"label":"Insurance Interval","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":308,"name":"Last Full Service","description":"","widgetId":12,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":12,"name":"date","widgetCategoryTypeId":2,"editWidget":"date","filterWidget":"date"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":308,"dataSourceId":11,"isKey":false,"id":109,"optionsJson":{},"label":"Last Full Service","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":311,"name":"Length","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":311,"dataSourceId":11,"isKey":false,"id":111,"optionsJson":{},"label":"Length","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":312,"name":"License Interval","description":"","widgetId":1,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":1,"name":"select","widgetCategoryTypeId":1,"editWidget":"select-autocomplete","filterWidget":"select-autocomplete"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":312,"dataSourceId":11,"isKey":false,"id":110,"optionsJson":{},"label":"License Interval","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":315,"name":"Maintenance Due","description":"","widgetId":12,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":12,"name":"date","widgetCategoryTypeId":2,"editWidget":"date","filterWidget":"date"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":315,"dataSourceId":11,"isKey":false,"id":112,"optionsJson":{},"label":"Maintenance Due","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":316,"name":"Maintenance Interval","description":"","widgetId":1,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":1,"name":"select","widgetCategoryTypeId":1,"editWidget":"select-autocomplete","filterWidget":"select-autocomplete"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":316,"dataSourceId":11,"isKey":false,"id":113,"optionsJson":{},"label":"Maintenance Interval","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":318,"name":"Make","description":"","widgetId":14,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":14,"name":"textbox","widgetCategoryTypeId":3,"editWidget":"textbox","filterWidget":"select-autocomp"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":318,"dataSourceId":11,"isKey":true,"id":114,"optionsJson":{},"label":"Make","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":364,"name":"Wheelbase","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":364,"dataSourceId":11,"isKey":false,"id":126,"optionsJson":{},"label":"Wheelbase","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":365,"name":"Width","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":365,"dataSourceId":11,"isKey":false,"id":127,"optionsJson":{},"label":"Width","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":322,"name":"Number of Axles","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":322,"dataSourceId":11,"isKey":false,"id":116,"optionsJson":{},"label":"Number of Axles","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":324,"name":"Odometer","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":324,"dataSourceId":11,"isKey":false,"id":117,"optionsJson":{},"label":"Odometer","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":325,"name":"Overheight Renewal","description":"","widgetId":14,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":14,"name":"textbox","widgetCategoryTypeId":3,"editWidget":"textbox","filterWidget":"select-autocomp"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":325,"dataSourceId":11,"isKey":false,"id":118,"optionsJson":{},"label":"Overheight Renewal","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":326,"name":"Overlength Renewal","description":"","widgetId":14,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":14,"name":"textbox","widgetCategoryTypeId":3,"editWidget":"textbox","filterWidget":"select-autocomp"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":326,"dataSourceId":11,"isKey":false,"id":119,"optionsJson":{},"label":"Overlength Renewal","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":327,"name":"Owner","description":"","widgetId":14,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":14,"name":"textbox","widgetCategoryTypeId":3,"editWidget":"textbox","filterWidget":"select-autocomp"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":327,"dataSourceId":11,"isKey":false,"id":100,"optionsJson":{},"label":"Owner","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":342,"name":"Registration Due","description":"","widgetId":12,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":12,"name":"date","widgetCategoryTypeId":2,"editWidget":"date","filterWidget":"date"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":342,"dataSourceId":11,"isKey":false,"id":120,"optionsJson":{},"label":"Registration Due","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":343,"name":"Registration Interval","description":"","widgetId":1,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":1,"name":"select","widgetCategoryTypeId":1,"editWidget":"select-autocomplete","filterWidget":"select-autocomplete"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":343,"dataSourceId":11,"isKey":false,"id":121,"optionsJson":{},"label":"Registration Interval","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":348,"name":"Service Status","description":"","widgetId":1,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":1,"name":"select","widgetCategoryTypeId":1,"editWidget":"select-autocomplete","filterWidget":"select-autocomplete"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":348,"dataSourceId":11,"isKey":false,"id":122,"optionsJson":{},"label":"Service Status","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":355,"name":"Status","description":"","widgetId":1,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":1,"name":"select","widgetCategoryTypeId":1,"editWidget":"select-autocomplete","filterWidget":"select-autocomplete"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":355,"dataSourceId":11,"isKey":false,"id":123,"optionsJson":{},"label":"Status","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":356,"name":"Sub-Model","description":"","widgetId":14,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":14,"name":"textbox","widgetCategoryTypeId":3,"editWidget":"textbox","filterWidget":"select-autocomp"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":356,"dataSourceId":11,"isKey":false,"id":124,"optionsJson":{},"label":"Sub-Model","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":357,"name":"System ID Number","description":"","widgetId":19,"displayFormatId":12,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":357,"dataSourceId":11,"isKey":false,"id":97,"optionsJson":{},"label":"System ID Number","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":363,"name":"Weight","description":"","widgetId":19,"displayFormatId":13,"domainDictionaryTypeId":2,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":19,"name":"integer","widgetCategoryTypeId":4,"editWidget":"integer","filterWidget":"select-autocomp"},"displayFormat":{"id":13,"name":"normal","label":"Normal","helpText":"Just right-aligned","format":""},"sourceField":{"domainDictId":363,"dataSourceId":11,"isKey":false,"id":125,"optionsJson":{},"label":"Weight","tenantId":3,"sortOrder":0}},{"ddEntry":{"id":320,"name":"Model","description":"","widgetId":14,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":14,"name":"textbox","widgetCategoryTypeId":3,"editWidget":"textbox","filterWidget":"select-autocomp"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":320,"dataSourceId":11,"isKey":true,"id":115,"optionsJson":{},"label":"Model","tenantId":3,"sortOrder":1}},{"ddEntry":{"id":347,"name":"Serial #","description":"","widgetId":14,"displayFormatId":12,"domainDictionaryTypeId":1,"createdTs":{"time":1417197379213},"modifiedTs":{"time":1417197379213}},"widget":{"id":14,"name":"textbox","widgetCategoryTypeId":3,"editWidget":"textbox","filterWidget":"select-autocomp"},"displayFormat":{"id":12,"name":"default","label":"Default","helpText":"Original value","format":""},"sourceField":{"domainDictId":347,"dataSourceId":11,"isKey":true,"id":98,"optionsJson":{},"label":"Serial #","tenantId":3,"sortOrder":2}}]}

var t = compileFile(path.resolve(__dirname + '/../examples/example1.kale'));
var dataSourceForPost = t.dataSource(input2, {});

console.log(JSON.stringify(dataSourceForPost));

// Exports
module.exports = {
  compile: compile,
  compileFile: compileFile,
  render: render,
  renderFile: renderFile,
  addAction: addAction
}